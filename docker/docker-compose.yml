services:
  gtfs_db:
    image: postgres:17
    environment:
      POSTGRES_DB: mpk_db
      POSTGRES_USER: mpk
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - gtfs_pg:/var/lib/postgresql/data
    secrets:
      - db_password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mpk -d mpk_db"]
      interval: 5s
      timeout: 3s
      retries: 30

  redis:
    image: redis:7-alpine
    command: redis-server --aclfile /usr/local/etc/redis/users.acl
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - ../redis/users.acl:/usr/local/etc/redis/users.acl:ro

secrets:
  db_password:
    file: ../secrets/db_password

volumes:
  gtfs_pg:
